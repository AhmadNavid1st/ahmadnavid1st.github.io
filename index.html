<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ahmad Navid — Messenger</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Palette: 28 colors (used across UI) */
    :root{
      --palette: #FF6B6B,#FF8E72,#FFD93D,#FFE6A7,#8BE3A7,#4FE3A6,#3DDC97,#49C5B6,#59C3F3,#6BA4FF,#7D8CFF,#B190FF,#D07BFF,#FF9BD4,#FFB3E6,#FDE2E2,#E8F0FF,#CDEAF8,#D7FBE8,#E6FFFA,#FFF3E0,#FBE9E7,#F5F1FF,#EEF2FF,#E8F7FF,#FFF0F5,#F0FFF7,#FFF6EA;
      --bg-image: url('photo.jpg');
      --glass: rgba(255,255,255,0.08);
      --glass-2: rgba(255,255,255,0.06);
      --radius: 14px;
      --accent: #2B7AE4;
    }
    html,body{height:100%;margin:0;font-family:Inter, Vazirmatn, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}
    body{
      background-image: linear-gradient(135deg, rgba(0,0,0,0.35), rgba(0,0,0,0.25)), var(--bg-image);
      background-size: cover;background-position:center; color: #f7f9fb; -webkit-font-smoothing:antialiased;display:flex;align-items:center;justify-content:center;padding:28px;
    }

    /* Main container */
    .app{width:100%;max-width:1100px;height:820px;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:20px;box-shadow:0 10px 40px rgba(2,6,23,0.6);display:grid;grid-template-columns:340px 1fr;overflow:hidden}

    /* Left column (contacts / info) */
    .left{padding:20px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-right:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#8b5cf6);display:flex;align-items:center;justify-content:center;font-weight:700}
    .brand h1{font-size:18px;margin:0}
    .lang-toggle{margin-left:auto;display:flex;gap:8px}
    .lang-toggle button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 10px;border-radius:8px;color:inherit;cursor:pointer}

    .contact-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));padding:12px;border-radius:12px;display:flex;gap:12px;align-items:center}
    .contact-card img{width:44px;height:44px;border-radius:10px;object-fit:cover}
    .contact-card .meta{display:flex;flex-direction:column}
    .contact-card .meta small{opacity:0.9}

    /* Right column (chat) */
    .chat{display:flex;flex-direction:column;height:100%;}
    .chat-header{padding:22px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;gap:12px}
    .chat-body{flex:1;padding:24px;overflow:auto;background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.00));display:flex;flex-direction:column;gap:12px}

    /* message bubbles */
    .bubble{max-width:72%;padding:12px 14px;border-radius:12px;backdrop-filter: blur(6px);box-shadow: 0 6px 18px rgba(2,6,23,0.45);}
    .bubble.me{margin-left:auto;border-bottom-right-radius:4px}
    .bubble.them{margin-right:auto;border-bottom-left-radius:4px}
    .bubble .meta{font-size:12px;opacity:0.8;margin-bottom:6px}
    .bubble .content{white-space:pre-wrap}

    /* input area */
    .composer{padding:18px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:12px;align-items:center}
    .composer textarea{flex:1;min-height:48px;max-height:160px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;resize:vertical}
    .composer .actions{display:flex;gap:8px}
    .btn{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),#8b5cf6);cursor:pointer;color:white;font-weight:600}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);}
    .small{font-size:13px;padding:8px 10px}

    /* colorful accent bar */
    .palette{display:flex;gap:6px;padding:10px;border-radius:10px;flex-wrap:wrap}
    .palette .color{width:18px;height:18px;border-radius:4px;border:1px solid rgba(0,0,0,0.12)}

    /* responsive */
    @media (max-width:880px){.app{grid-template-columns:1fr}.left{display:none}.app{height:100vh;border-radius:0}}

    /* Persian readable font fallback */
    [lang="fa"]{font-family:Vazirmatn, Inter, system-ui}
  </style>
</head>
<body>
  <!-- Load a config file generated by Actions: docs/config.js -->
  <script src="/config.js" defer></script>

  <div class="app" id="app" lang="en">
    <div class="left">
      <div class="brand">
        <div class="logo">AN</div>
        <div>
          <h1 id="brand-title">Ahmad Navid — Messenger</h1>
          <small id="brand-sub">Secure file & message relay via Telegram bot</small>
        </div>
        <div class="lang-toggle" style="margin-left:auto">
          <button id="btn-en">EN</button>
          <button id="btn-fa">FA</button>
        </div>
      </div>

      <div class="contact-card">
        <img src="photo.jpg" alt="avatar">
        <div class="meta">
          <strong id="owner-name">Ahmad Navid</strong>
          <small id="owner-id">Admin</small>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:10px">
        <div class="palette" id="palette"></div>
        <div style="font-size:13px;opacity:0.9">Please send your message to Ahmad Navid.</div>
      </div>

      <div style="margin-top:auto;font-size:12px;opacity:0.9">Built for <b>AhmadNavid1st.github.io</b></div>
    </div>

    <div class="chat">
      <div class="chat-header">
        <div style="font-weight:700">Send a message</div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <small id="status">ready</small>
        </div>
      </div>

      <div class="chat-body" id="chat-body">
        <div class="bubble them" style="background:linear-gradient(90deg,var(--palette-color-0),var(--palette-color-1));">
          <div class="meta">Welcome — choose language and send a file or message.</div>
          <div class="content" id="welcome-text">Please send your message to Ahmad Navid.</div>
        </div>
      </div>

      <div class="composer">
        <input type="file" id="file-input" style="display:none">
        <button class="btn secondary small" id="attach-btn">📎 Attach</button>
        <textarea id="message-input" placeholder="Write a message..." rows="2"></textarea>
        <div class="actions">
          <button class="btn small" id="send-btn">Send</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ==========================
       Configuration & helpers
       ==========================
       The file `/config.js` should set window.APP_CONFIG = { BOT_TOKEN, ADMIN_ID, PROXY_URL }
       If PROXY_URL is set (e.g. your server), the frontend will POST to it and it will forward to Telegram.
       If PROXY_URL is empty, the frontend will attempt a direct call to Telegram Bot API (CORS may block this).
    */

    const CFG = window.APP_CONFIG || { BOT_TOKEN: '', ADMIN_ID: '', PROXY_URL: '' };

    // color palette parsing
    const palette = getComputedStyle(document.documentElement).getPropertyValue('--palette').split(',').map(s=>s.trim());
    // ensure at least 24 colors available; if not, duplicate
    while(palette.length < 24){ palette.push(...palette); }

    // UI elements
    const app = document.getElementById('app');
    const bodyEl = document.getElementById('chat-body');
    const input = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const attachBtn = document.getElementById('attach-btn');
    const fileInput = document.getElementById('file-input');
    const statusEl = document.getElementById('status');

    // fill palette UI
    const paletteEl = document.getElementById('palette');
    palette.slice(0,28).forEach(c=>{const d=document.createElement('div');d.className='color';d.style.background=c;paletteEl.appendChild(d);});

    // language support
    const texts = {
      en: {
        send: 'Send', attach: 'Attach', placeholder: 'Write a message...', welcome: 'This will deliver messages & files to the admin via Telegram.'
      },
      fa: {
        send: 'ارسال', attach: 'پیوست', placeholder: 'پیام خود را بنویسید...', welcome: 'این صفحه پیام‌ها و فایل‌ها را از طریق تلگرام برای ادمین ارسال می‌کند.'
      }
    };
    function setLang(lang){
      app.lang = lang === 'fa' ? 'fa' : 'en';
      document.getElementById('welcome-text').textContent = texts[lang].welcome;
      document.getElementById('message-input').placeholder = texts[lang].placeholder;
      document.getElementById('send-btn').textContent = texts[lang].send;
      document.getElementById('attach-btn').textContent = '📎 ' + texts[lang].attach;
      if(lang === 'fa'){document.documentElement.lang='fa';}
      else{document.documentElement.lang='en';}
    }
    document.getElementById('btn-en').addEventListener('click', ()=>setLang('en'));
    document.getElementById('btn-fa').addEventListener('click', ()=>setLang('fa'));
    setLang('en');

    // small util: escape HTML for safe insertion into Telegram HTML parse_mode
    function escapeForHtml(s){
      if(!s) return '';
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // detect device type
    function detectDevice(){
      const ua = navigator.userAgent || '';
      if(/Mobi|Android|iPhone|iPad|Tablet/i.test(ua)){
        if(/Tablet|iPad/i.test(ua)) return 'Tablet';
        return 'Mobile';
      }
      return 'Desktop';
    }

    // Build a beautiful HTML message (Telegram HTML parse_mode)
    async function buildMessageHTML(userText){
      const ua = navigator.userAgent || 'unknown';
      const platform = navigator.platform || 'unknown';
      const device = detectDevice();
      const width = screen.width || 0, height = screen.height || 0;
      const lang = navigator.language || 'unknown';
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || '';

      // IP lookup (client-side)
      let ip = 'unknown';
      let ipInfo = null;
      try{
        const r = await fetch('https://ipapi.co/json/');
        if(r.ok) ipInfo = await r.json();
        if(ipInfo && ipInfo.ip) ip = ipInfo.ip;
      }catch(e){
        try{const r2 = await fetch('https://api.ipify.org?format=json'); if(r2.ok){const j=await r2.json(); ip=j.ip;}}catch(e){}
      }

      const time = new Date().toLocaleString();
      const sanitized = escapeForHtml(userText);

      // Build a polished HTML card for Telegram (using supported tags)
      const location = ipInfo && (ipInfo.city || ipInfo.region || ipInfo.country_name) ? escapeForHtml([ipInfo.city, ipInfo.region, ipInfo.country_name].filter(Boolean).join(', ')) : '';
      const org = ipInfo && ipInfo.org ? escapeForHtml(ipInfo.org) : '';
      const ipLink = ip !== 'unknown' ? `<a href="https://ipinfo.io/${ip}">${escapeForHtml(ip)}</a>` : escapeForHtml(ip);

      const html = `
<b>📬 New message — Ahmad Navid</b>

<b>Time:</b> <i>${escapeForHtml(time)}</i>

<b>Message:</b>
<pre>${sanitized}</pre>

<b>Sender details</b>

• <b>Device:</b> <i>${escapeForHtml(device)}</i> — <code>${escapeForHtml(platform)}</code>

• <b>Screen:</b> <code>${width}×${height}</code>

• <b>Language:</b> <i>${escapeForHtml(lang)}</i> — <b>Timezone:</b> <i>${escapeForHtml(tz)}</i>

• <b>IP:</b> <code>${ipLink}</code>${location ? ' — <i>'+location+'</i>' : ''}${org ? ' — <i>'+org+'</i>' : ''}

<b>UA (trimmed):</b> <code>${escapeForHtml(ua.substring(0,200))}${ua.length>200? '...':''}</code>
`;
      return html;
    }

      const time = new Date().toLocaleString();

      const sanitized = escapeForHtml(userText);

      // compose HTML (Telegram supports <b>, <i>, <code>, <pre>, <a>)
      const html = `
<b>📨 New message from website</b>\n
<b>Time:</b> <i>${escapeForHtml(time)}</i>\n
<b>Sender message</b>:\n<pre>${sanitized}</pre>\n
<b>Device:</b> <i>${escapeForHtml(device)}</i> — <code>${escapeForHtml(platform)}</code>\n
<b>Screen:</b> <code>${width}×${height}</code>  <b>Language:</b> <i>${escapeForHtml(lang)}</i>\n
<b>IP:</b> <code>${escapeForHtml(ip)}</code> ${ipInfo && ipInfo.city ? ' — <i>'+escapeForHtml(ipInfo.city+', '+ipInfo.region+', '+ipInfo.country_name)+'</i>' : ''}\n
<b>User Agent:</b> <code>${escapeForHtml(ua)}</code>
`;
      return html;
    }

    // append local bubble
    function appendBubble(content, who='me', extraClass=''){
      const el = document.createElement('div');
      el.className = 'bubble ' + (who === 'me' ? 'me' : 'them') + ' ' + extraClass;
      // give a gradient using two random palette colors
      const a = Math.floor(Math.random()*palette.length), b = (a+3)%palette.length;
      el.style.background = `linear-gradient(90deg, ${palette[a]}, ${palette[b]})`;
      el.innerHTML = '<div class="content">'+content+'</div>';
      bodyEl.appendChild(el);
      bodyEl.scrollTop = bodyEl.scrollHeight;
      return el;
    }

    // send text message (uses proxy if provided)
    async function sendTextMessage(userText){
      const html = await buildMessageHTML(userText);

      // Attempt to send via proxy if provided
      if(CFG.PROXY_URL){
        statusEl.textContent = 'sending via proxy...';
        try{
          const res = await fetch(CFG.PROXY_URL.replace(/\/$/, '') + '/sendMessage', {
            method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:CFG.ADMIN_ID,text:html,parse_mode:'HTML'})
          });
          const j = await res.json();
          if(j.ok) statusEl.textContent = 'sent ✅'; else statusEl.textContent = 'failed';
          return j;
        }catch(e){statusEl.textContent='proxy error';console.error(e);throw e}
      }

      // If no proxy, attempt direct Telegram API call (may be blocked by CORS)
      if(!CFG.BOT_TOKEN){
        statusEl.textContent = 'no token configured'; throw new Error('BOT_TOKEN not set');
      }
      const url = `https://api.telegram.org/bot${CFG.BOT_TOKEN}/sendMessage`;
      statusEl.textContent = 'sending directly...';
      try{
        const res = await fetch(url, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:CFG.ADMIN_ID,text:html,parse_mode:'HTML'})});
        const j = await res.json();
        if(!j.ok){statusEl.textContent='error';console.error(j);}
        else statusEl.textContent='sent ✅';
        return j;
      }catch(e){statusEl.textContent='network error';console.error(e);throw e}
    }

    // send document (file). If proxy present, POST form-data to it and it will forward.
    async function sendFile(file){
      appendBubble('<b>Uploading file:</b> ' + escapeForHtml(file.name), 'me');
      if(CFG.PROXY_URL){
        statusEl.textContent = 'uploading via proxy...';
        const fd = new FormData(); fd.append('file', file); fd.append('chat_id', CFG.ADMIN_ID);
        try{
          const res = await fetch(CFG.PROXY_URL.replace(/\/$/, '') + '/sendDocument', {method:'POST',body:fd});
          const j = await res.json();
          if(j.ok) statusEl.textContent = 'file sent ✅'; else statusEl.textContent = 'failed';
          return j;
        }catch(e){statusEl.textContent='proxy error';throw e}
      }

      // Attempt direct upload to Telegram (CORS likely to block this in browsers)
      if(!CFG.BOT_TOKEN) throw new Error('BOT_TOKEN missing');
      const url = `https://api.telegram.org/bot${CFG.BOT_TOKEN}/sendDocument`;
      const fd = new FormData(); fd.append('chat_id', CFG.ADMIN_ID); fd.append('document', file, file.name);
      statusEl.textContent = 'uploading directly...';
      try{
        const res = await fetch(url, {method:'POST',body:fd});
        const j = await res.json();
        if(j.ok) statusEl.textContent = 'file sent ✅'; else statusEl.textContent = 'failed';
        return j;
      }catch(e){statusEl.textContent='network error';throw e}
    }

    // events
    attachBtn.addEventListener('click', ()=>fileInput.click());
    fileInput.addEventListener('change', async (ev)=>{
      const file = ev.target.files[0]; if(!file) return;
      try{ await sendFile(file); }catch(e){console.error(e); appendBubble('⚠️ Error uploading file. See console for details.','them')}
      fileInput.value = '';
    });

    sendBtn.addEventListener('click', async ()=>{
      const t = input.value.trim(); if(!t){appendBubble('Please type a message or attach a file.','them');return}
      appendBubble(escapeForHtml(t), 'me');
      input.value = '';
      try{ await sendTextMessage(t); }catch(e){console.error(e); appendBubble('⚠️ Could not send message.','them') }
    });

    // keyboard shortcut: Ctrl+Enter send
    input.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key === 'Enter'){ sendBtn.click(); } });

    // On first load, show whether token is set
    (function checkConfig(){
      if(!CFG.BOT_TOKEN || !CFG.ADMIN_ID){ statusEl.textContent = 'CONFIG MISSING — see README'; appendBubble('⚠️ Token / Admin not configured. Check README.','them'); }
      else{ statusEl.textContent = 'ready'; }
    })();

  </script>
</body>
</html>
